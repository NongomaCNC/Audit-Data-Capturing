<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Field Data Capture</title>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        /* ...existing CSS from your code... */
        /* For brevity, copy your CSS here */
    </style>
</head>
<body>
    <h1>Field Data Capture</h1>
    <!-- Form for data entry -->
    <form id="captureForm">
        <!-- ...existing form fields from your code... -->
        <!-- For brevity, copy your form fields here -->
        <div class="actions">
            <button type="button" id="gpsBtn">Get GPS</button>
            <button type="button" id="viewDataBtn">View Data</button>
            <button type="button" id="exportBtn">Download Excel</button>
            <button type="button" id="syncBtn">Sync Data (WIP)</button>
            <button type="submit" id="submitBtn">Save Data</button>
        </div>
    </form>
    <div id="message" role="alert" aria-live="polite"></div>
    <div id="savedDataSection">
        <h2>Saved Field Entries</h2>
        <div id="savedDataTableContainer">
            <table id="savedDataTable">
                <thead>
                    <tr id="savedTableHeader"></tr>
                </thead>
                <tbody id="savedTableBody"></tbody>
            </table>
        </div>
        <div id="savedDataActions">
            <button type="button" id="clearDataBtn">Clear All Saved Data</button>
            <button type="button" id="closeViewDataBtn">Close View</button>
        </div>
    </div>
    <script>
        // --- INITIAL USE INSTRUCTIONS ---
        // 1. Place this file (index.html) in your project folder.
        // 2. Make sure you have a manifest.json and service-worker.js in the same folder if you want PWA features.
        // 3. Open index.html in your browser (double-click or use a local server).
        // 4. All data is stored locally in your browser using IndexedDB.
        // 5. You can export your data to Excel at any time.

        // --- IndexedDB Setup ---
        const DB_NAME = 'FieldDataDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'records';
        let db;
        function initDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    showMessage('Database error: ' + event.target.errorCode, 'error');
                    reject(event.target.error);
                };
            });
        }
        function addRecord(record) {
            return new Promise((resolve, reject) => {
                if (!db) { showMessage('Database not initialized.', 'error'); return; }
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.add(record);
                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    showMessage('Error saving data.', 'error');
                    reject(event.target.error);
                };
            });
        }
        function getAllRecords() {
            return new Promise((resolve, reject) => {
                if (!db) { showMessage('Database not initialized.', 'error'); return; }
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    showMessage('Error retrieving data for export.', 'error');
                    reject(event.target.error);
                };
            });
        }
        function clearAllRecords() {
            return new Promise((resolve, reject) => {
                if (!db) { showMessage('Database not initialized.', 'error'); return; }
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    showMessage('Error clearing data.', 'error');
                    reject(event.target.error);
                };
            });
        }
        // --- UI Message ---
        const messageElement = document.getElementById('message');
        function showMessage(msg, type = 'info', duration = 3000) {
            messageElement.textContent = msg;
            messageElement.className = 'show';
            if (type === 'error') {
                messageElement.style.backgroundColor = 'rgba(220, 53, 69, 0.8)';
            } else if (type === 'success') {
                messageElement.style.backgroundColor = 'rgba(40, 167, 69, 0.8)';
            } else {
                messageElement.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            }
            setTimeout(() => {
                messageElement.classList.remove('show');
            }, duration);
        }
        // --- GPS Conversion ---
        function toDMS(dec, type) {
            const abs = Math.abs(dec);
            const deg = Math.floor(abs);
            const minF = (abs - deg) * 60;
            const min = Math.floor(minF);
            const sec = ((minF - min) * 60).toFixed(3);
            let hemisphere = '';
            if (type === 'latitude') hemisphere = dec >= 0 ? 'N' : 'S';
            if (type === 'longitude') hemisphere = dec >= 0 ? 'E' : 'W';
            return `${String(deg).padStart(2, '0')} ${String(min).padStart(2, '0')} ${sec.padStart(6, '0')} ${hemisphere}`;
        }
        // --- On Load ---
        window.addEventListener('load', () => {
            // Service Worker registration (optional)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => console.log('Service Worker Registered', registration))
                    .catch(error => console.error('Service Worker Registration Failed', error));
            }
            // Initialize DB and get GPS
            initDb().then(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        pos => {
                            document.getElementById('lat').value = toDMS(pos.coords.latitude, 'latitude');
                            document.getElementById('lon').value = toDMS(pos.coords.longitude, 'longitude');
                            showMessage('Initial GPS acquired.', 'success', 2000);
                        },
                        err => {
                            showMessage('Could not get initial GPS. Tap "Get GPS" if needed.', 'info', 4000);
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
                    );
                } else {
                    showMessage('Geolocation not supported by your browser.', 'error');
                }
            }).catch(e => {
                showMessage('Failed to initialize local database.', 'error');
            });
            // Set current date
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        });
        // --- GPS Button ---
        document.getElementById('gpsBtn').onclick = () => {
            if (!navigator.geolocation) {
                showMessage('Geolocation not supported by your browser.', 'error');
                return;
            }
            showMessage('Getting GPS...', 'info', 5000);
            navigator.geolocation.getCurrentPosition(
                pos => {
                    document.getElementById('lat').value = toDMS(pos.coords.latitude, 'latitude');
                    document.getElementById('lon').value = toDMS(pos.coords.longitude, 'longitude');
                    showMessage('GPS acquired successfully!', 'success');
                },
                err => {
                    showMessage(`GPS Error: ${err.message}`, 'error');
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        };
        // --- Form Submit ---
        document.getElementById('captureForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            if (!data.transformerNo.trim()) {
                showMessage('Transformer Number is mandatory.', 'error');
                document.getElementById('transformerNo').focus();
                return;
            }
            if (data.date) {
                const d = new Date(data.date);
                const yyyy = d.getFullYear();
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                data.date = `${yyyy}/${mm}/${dd}`;
            }
            try {
                await addRecord(data);
                showMessage('Data saved successfully offline âœ”', 'success');
                this.reset();
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
                document.getElementById('lat').value = '';
                document.getElementById('lon').value = '';
            } catch (error) {
                showMessage('Failed to save data.', 'error');
            }
        });
        // --- Excel Export ---
        document.getElementById('exportBtn').addEventListener('click', async () => {
            let recordsToExport = [];
            try {
                recordsToExport = await getAllRecords();
            } catch (error) {
                showMessage('Could not retrieve data for export.', 'error');
                return;
            }
            if (recordsToExport.length === 0) {
                showMessage('No data to export.', 'info');
                return;
            }
            const map = {
                workorderNo: "Workorder No", zone: "Zone", sector: "Sector", cnc: "CNC",
                contractorName: "Contractor Name", date: "Date", feederName: "Feeder Name",
                townshipName: "Township Name", transformerNo: "Transformer No", standNo: "Stand No",
                installationNo: "Installation No", latitude: "Latitude", longitude: "Longitude",
                access: "Access", atHome: "At Home", connected: "Connected", abandoned: "Abandoned",
                vandalised: "Vandalised", illegal: "Illegal", owner: "Owner", surname: "Surname",
                name: "Name", idNo: "ID No", phoneCode: "Phone Code", phoneNo: "Phone No",
                normalVendor: "Normal Vendor", recentVendor: "Most Recent Vendor", meterNo: "Meter No",
                split: "Split", commonBaseMeter: "Common/Non Common Base Meter", edEcu: "ED/ECU",
                meterType: "Meter Type", tariffCode: "Tariff Code", ampLimit: "Amp Limit",
                supplyGroupCode: "Supply Group Code", magCard: "Mag Card/Keypad", stsOrProp: "STS or Prop",
                tampered: "Tampered", tamperMethod: "Tamper Method", removed: "Removed",
                tamperNotNo: "Tamper Not No", cardTrip: "Card Trip", elTest: "E/L Test",
                meterFaulty: "Meter Faulty", replaced: "Replaced", mmfNo: "MMF No",
                newMeterNo: "New Meter No", newMeterType: "New Meter Type",
                newMeterAmpLimit: "New Meter Amp Limit", newMeterCardTrip: "New Meter Card Trip",
                newMeterElTest: "New Meter E/L Test", sealed: "Sealed", sealNo: "Seal No",
                remarks: "Remarks"
            };
            const formatted = recordsToExport.map(rec => {
                const obj = {};
                for (const k in rec) {
                    if (k !== 'id') {
                        obj[map[k] || k] = rec[k];
                    }
                }
                return obj;
            });
            try {
                const ws = XLSX.utils.json_to_sheet(formatted);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'FieldData');
                XLSX.writeFile(wb, 'Field_Data.xlsx');
                showMessage('Data exported to Excel successfully!', 'success');
            } catch (error) {
                showMessage('Error exporting data to Excel.', 'error');
            }
        });
        // --- Sync Data (Placeholder) ---
        document.getElementById('syncBtn').addEventListener('click', async () => {
            showMessage('Sync functionality is under development.', 'info', 3000);
        });
        // --- View Saved Data ---
        const savedDataSection = document.getElementById('savedDataSection');
        const savedTableHeader = document.getElementById('savedTableHeader');
        const savedTableBody = document.getElementById('savedTableBody');
        document.getElementById('viewDataBtn').addEventListener('click', async () => {
            if (savedDataSection.classList.contains('visible')) {
                savedDataSection.classList.remove('visible');
                showMessage('Data view closed.', 'info', 2000);
                return;
            }
            try {
                const records = await getAllRecords();
                if (records.length === 0) {
                    showMessage('No saved data to display.', 'info');
                    return;
                }
                const allKeys = new Set();
                records.forEach(record => {
                    Object.keys(record).forEach(key => {
                        if (key !== 'id') allKeys.add(key);
                    });
                });
                const headers = Array.from(allKeys).sort();
                savedTableHeader.innerHTML = '';
                savedTableBody.innerHTML = '';
                headers.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    savedTableHeader.appendChild(th);
                });
                records.forEach(record => {
                    const tr = document.createElement('tr');
                    headers.forEach(key => {
                        const td = document.createElement('td');
                        td.textContent = record[key] || '';
                        tr.appendChild(td);
                    });
                    savedTableBody.appendChild(tr);
                });
                savedDataSection.classList.add('visible');
                showMessage('Displaying saved data.', 'success', 2000);
            } catch (error) {
                showMessage('Failed to load saved data.', 'error');
            }
        });
        document.getElementById('closeViewDataBtn').addEventListener('click', () => {
            savedDataSection.classList.remove('visible');
            showMessage('Data view closed.', 'info', 2000);
        });
        // --- Clear All Saved Data ---
        document.getElementById('clearDataBtn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to clear ALL saved data? This cannot be undone.')) {
                try {
                    await clearAllRecords();
                    savedTableBody.innerHTML = '';
                    savedTableHeader.innerHTML = '';
                    savedDataSection.classList.remove('visible');
                    showMessage('All saved data cleared successfully!', 'success');
                } catch (error) {
                    showMessage('Failed to clear all data.', 'error');
                }
            }
        });
    </script>
</body>
</html>
